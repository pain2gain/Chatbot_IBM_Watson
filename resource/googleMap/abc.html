<!DOCTYPE html>
<html>
<head>
  <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <style type="text/css">
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; }
        .serachAddress li { list-style-type: none; border: 1px solid #ccc; padding: 2px 5px; margin-bottom: 5px; }
        .tit { font-size: 12px; font-weight: bold; }
        .txt { font-size: 10px; }
        .msgDiv { display: inline-block; background: #fff; box-shadow: 3px 3px 3px 3px #c4c4c4; border: 1px solid #f64323; text-align: center; padding: 5px 16px; }
    </style>
</head>
<body>
    <div>
        <div id="map" style=" margin:0 auto;"></div>
    </div>
    <div style="padding:20px;">
        <div>
            <input type="button" value="Actuel Positionnement" onclick="pageObj.fn.getPosition()" />
        </div>
        <div>
            <input type="text" placeholder="Ecrivez votre adresse..." id="txtAutoCompute" oninput="pageObj.fn.AutocompleteSearch()" />
        </div>
        <div>
            <ul class="serachAddress" id="autoSearchPlace">

            </ul>
        </div>
    </div>


    <script type="text/javascript">
        //地址搜索匹配可能結果（列表）
        var autocompleteService;
        //地址模糊匹配地理界限範圍
        var bounds;
        //地區消息
        var infowindow;
        //地址id解析器
        var geocoder;
        //定位標記
        var goDoorMarker;
        var posiontShow = 30;

        var pageObj = {

            fn: {
                //地址輸入搜索可能結果匹配（結果為列表）
                AutocompleteSearch: function () {
                    var address = document.getElementById('txtAutoCompute').value;
                    console.log(address);
                    if (address == "") {
                        return;
                    }
                    document.getElementById("autoSearchPlace").innerHTML = "En cours de chercher...";
                    function displaySuggestions(predictions, status) {
                        if (status != google.maps.places.PlacesServiceStatus.OK) {
                            console.log(status);
                            return;
                        }
                        searchArr = predictions;
                        console.log(predictions);
                        var htmlArr = new Array();
                        predictions.forEach(function (prediction) {
                            var html = '<li placeId="' + prediction.place_id + '" >' +
                                '<div class="tit">' + prediction.structured_formatting.main_text + '</div>' +
                                '<div class="txt">' + prediction.description + '</div>' +
                                '</li>';
                            htmlArr.push(html);
                            /*var result_mark = new google.maps.Marker({ position:  });
                            result_mark.setMap(map);
                            map.panTo(prediction);*/
                        });
                        document.getElementById("autoSearchPlace").innerHTML = htmlArr.join('');
                    };
                    var request = {
                        //地址模糊匹配地理界限範圍
                        //如果定位成功，則首選匹配查詢結果在此城市中
                        bounds: bounds,
                        input: address,
                        //types: ['geocode']
                    }
                    autocompleteService.getPlacePredictions(request, displaySuggestions);
                    //autocompleteService.getQueryPredictions(request, displaySuggestions);
                }
                //獲取當前位置定位
                , getPosition: function () {
                    if (!navigator.geolocation) {
                        alert("當前不支持html5定位位置");
                        return;
                    }
                    var options =
                        {
                            enableHighAccuracy: true,//高精度定位
                            timeout: 3000,//毫秒，超時時間,超時后調用error
                            maximumAge: 0
                        };
                    navigator.geolocation.getCurrentPosition(function (position) {
                        console.log('當前定位：');
                        console.log(position);
                        var geolocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                  /*    var result_mark = new google.maps.Marker({ position: geolocation });
                        result_mark.setMap(map);
                        map.panTo(geolocation);*/

                        var circle = new google.maps.Circle({
                            center: geolocation,
                            radius: position.coords.accuracy
                        });
                        //pageObj.fn.goMapToByPlaceId(position.placeId);
                        //設置查詢地圖範圍界限
                        bounds = circle.getBounds();
                        //console.log(circle);
                        console.log("定位設置成功");
                        pageObj.fn.alertMsg("定位設置成功");
                        pageObj.fn.getCityName(geolocation);

                    }, function (error) {
                        //处理错误
                        switch (error.code) {
                            case 1:
                                console.log("位置服务被拒绝");
                                pageObj.fn.alertMsg("位置服务被拒绝");
                                break;
                            case 2:
                                console.log("暂时获取不到位置信息");
                                pageObj.fn.alertMsg("暂时获取不到位置信息");
                                break;
                            case 3:
                                console.log("获取定位信息超时");
                                pageObj.fn.alertMsg("获取定位信息超时");
                                break;
                            default:
                                console.log("未知错误");
                                pageObj.fn.alertMsg("未知错误");
                                break;
                        }
                    }, options);
                }
                //根據地址id轉換為地圖坐標
                , goMapToByPlaceId: function (placeId) {
                    geocoder.geocode({ 'placeId': placeId }, function (results, status) {
                        if (status === 'OK') {
                            var resultPosition = results[0];
                            console.log("定位地址：");
                            console.log(resultPosition);
                            if (resultPosition) {
                                map.setCenter(resultPosition.geometry.location);
                                goDoorMarker = new google.maps.Marker({
                                    map: map,
                                    position: resultPosition.geometry.location
                                });
                                goDoorMarker.address = resultPosition.formatted_address;
                                pageObj.fn.showMapInfo(resultPosition.formatted_address, goDoorMarker);
                            } else {
                                pageObj.fn.alertMsg(pageObj.words.noResult);
                            }
                        } else {
                            pageObj.fn.alertMsg(pageObj.words.positionDecodeError + ":" + status);
                        }
                    });
                }
                //根據經緯度坐標得到城市名稱
                , getCityName: function (latlng) {
                    geocoder.geocode({ 'location': latlng }, function (results, status) {
                        if (status === 'OK') {
                            console.log(results);
                            //獲取區縣名稱，匹配數據找出區縣id
                            var quxian = results.find(w => w.types.filter(x => x == "sublocality_level_1").length > 0);
                            if (quxian != undefined) {
                                var quxianObj = quxian.address_components.find(w => w.types.filter(x => x == "sublocality_level_1").length > 0);
                                if (quxianObj != undefined && quxianObj != null) {
                                    console.log("匹配到的區縣名稱=" + quxianObj.short_name);
                                }
                            }
                            var firstResult = results[0];
                            var name = '<li placeId="' +"caonima" + '" >' +
                                '<div class="tit">' + "nimabi"+ '</div>' +
                                '</li>';

                           $("#autoSearchPlace").html(name);
                            console.log("定位的詳細地址：");
                            console.log(firstResult);
                            //顯示定位標記
                            goDoorMarker = new google.maps.Marker({
                                map: map,
                                position: latlng
                            });
                            map.panTo(latlng);
                            goDoorMarker.address = firstResult.formatted_address;
                            pageObj.fn.showMapInfo(firstResult.formatted_address, goDoorMarker);
                        } else {
                            pageObj.fn.alertMsg(pageObj.words.latLngDecodeError + status);
                        }
                    });
                }
                //顯示白色消息框到地圖
                , showMapInfo: function (msg, marker) {
                    infowindow.setContent(msg);
                    if (marker != null && marker != undefined) {
                        infowindow.open(map, marker);
                    } else {
                        infowindow.open(map);
                    }
                }
                //彈消息框自動消失
                , alertMsg: function (msg) {
                    posiontShow = posiontShow + 5;
                    if (posiontShow > 60) {
                        posiontShow = 30;
                    }
                    var id = Math.round(Math.random() * 100000000);
                    var arrS = new Array();
                    arrS.push('<div id="' + id + '" style="position:fixed;z-index:2000;top:' + posiontShow + '%;width:100%;text-align:center;">');
                    arrS.push('<div class="msgDiv">');
                    arrS.push(msg);
                    arrS.push('</div></div>');
                    //document.getElementsByTagName("body")[0].innerHTML += arrS.join("");
                    var msgDom = document.createElement("div");
                    msgDom.innerHTML = arrS.join("");
                    document.getElementsByTagName("body")[0].appendChild(msgDom);
                    setTimeout(function () {
                        var dom = document.getElementById(id);
                        dom.parentNode.removeChild(dom);
                    }, 2000);
                }
                //fn結束
            }

            //pageObj 結束
        };

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: new google.maps.LatLng(45.767, 4.844),
                zoom: 12,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                mapTypeControl: false,
                scaleControl: false,
                streetViewControl: false,
                zoomControl: false,
                fullscreenControl: false
            });
            infowindow = new google.maps.InfoWindow;
            //地址id轉換為坐標
            geocoder = new google.maps.Geocoder;
            //地址搜索匹配多個結果
            autocompleteService = new google.maps.places.AutocompleteService();
            pageObj.fn.getPosition();
        }

        $("#autoSearchPlace").on("click","li",function(){
          //alert($(this).find(".tit").html());
          alert($(this).attr("id"));
          geocoder = new google.maps.Geocoder;
          geocoder.geocode({ 'placeId': $(this).attr("id") }, function (results, status) {
              if (status === 'OK') {
                  var resultPosition = results[0];
                  console.log("定位地址：");
                  console.log(resultPosition);
                  if (resultPosition) {
                      map.setCenter(resultPosition.geometry.location);
                      Marker = new google.maps.Marker({
                          map: map,
                          position: resultPosition.geometry.location
                      });
                      Marker.address = resultPosition.formatted_address;
                      pageObj.fn.showMapInfo(resultPosition.formatted_address, Marker);
                  } else {
                      pageObj.fn.alertMsg(pageObj.words.noResult);
                  }
              } else {
                  pageObj.fn.alertMsg(pageObj.words.positionDecodeError + ":" + status);
              }
          });
        });

    </script>
    <script src="http://maps.google.cn/maps/api/js?key=AIzaSyAcUbZlPh6ccA-zwtw_qHQnVGFoGY8z34M&libraries=places&callback=initMap" async defer></script>
</body>
</html>
